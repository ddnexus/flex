<!DOCTYPE html>
<html>
  <head>
    <link href='/flex/assets/global-9916d5b8228587acf80f3b6895466abf.css' rel='stylesheet' type='text/css' />
<script src='/flex/assets/global-a63e4d3d89edd2025dec6b2451238b9e.js' type='text/javascript'></script>

    <title>
      FlexDoc - flex - Template Sources
    </title>
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-42574355-2', 'ddnexus.github.io');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <div id="page-nav" class="nocontent">
      <ul id="nav-menu" class="menu_h_list"><li><a href="#" class="isLabel">Flex Project</a><ul><li><a href="/flex/doc/1-Flex-Project/1-Overview.html">Project Overview</a></li><li><a href="/flex/doc/1-Flex-Project/2-Usage-Overview.html">Usage Overview</a></li><li><a href="/flex/doc/1-Flex-Project/3-Configuration.html">Configuration</a></li><li><a href="/flex/doc/1-Flex-Project/4-Rake-Tasks.html">Rake Tasks</a></li></ul></li><li><a href="#" class="isLabel">flex</a><ul><li><a href="/flex/doc/2-flex/1-Overview.html">Overview</a></li><li><a href="/flex/doc/2-flex/2-API-Methods.html">API Methods</a></li><li><a href="#" class="isLabel">Templating</a><div class="arrow right"></div><ul><li><a href="/flex/doc/2-flex/3-Templating/1-Templates.html">Templates</a></li><li><a href="/flex/doc/2-flex/3-Templating/2-Sources.html">Template Sources</a></li><li><a href="/flex/doc/2-flex/3-Templating/3-Tags.html">Tags</a></li><li><a href="/flex/doc/2-flex/3-Templating/4-Variables.html">Variables</a></li><li><a href="/flex/doc/2-flex/3-Templating/5-Interpolation.html">Interpolation</a></li><li><a href="/flex/doc/2-flex/3-Templating/6-Partials.html">Partial Templates</a></li></ul></li><li><a href="/flex/doc/2-flex/4-Result-Extenders.html">Result Extenders</a></li><li><a href="/flex/doc/2-flex/5-Self-Documentation.html">Self Documentation</a></li><li><a href="/flex/doc/2-flex/6-Utility-Methods.html">Utility Methods</a></li></ul></li><li><a href="#" class="isLabel">flex-scopes</a><ul><li><a href="/flex/doc/3-flex-scopes/1-Overview.html">Overview</a></li><li><a href="/flex/doc/3-flex-scopes/2-Scopes.html">Scopes</a></li></ul></li><li><a href="#" class="isLabel">flex-models</a><ul><li><a href="/flex/doc/4-flex-models/1-Overview.html">Overview</a></li><li><a href="/flex/doc/4-flex-models/2-ActiveRecord-And-Mongoid-Integration.html">ActiveRecord And Mongoid Integration</a></li><li><a href="/flex/doc/4-flex-models/3-ActiveModel-Integration.html">ActiveModel Integration</a></li><li><a href="#" class="isLabel">Modules</a><div class="arrow right"></div><ul><li><a href="/flex/doc/4-flex-models/4-Modules/1-Flex::ModelSyncer.html">Flex::ModelSyncer</a></li><li><a href="/flex/doc/4-flex-models/4-Modules/2-Flex::ModelIndexer.html">Flex::ModelIndexer</a></li><li><a href="/flex/doc/4-flex-models/4-Modules/3-Flex::ActiveModel.html">Flex::ActiveModel</a></li></ul></li><li><a href="/flex/doc/4-flex-models/5-Result-Extenders.html">Result Extenders</a></li></ul></li><li><a href="#" class="isLabel">flex-rails</a><ul><li><a href="/flex/doc/5-flex-rails/1-overview.html">Overview</a></li><li><a href="/flex/doc/5-flex-rails/2-Result-Extenders.html">Result Extenders</a></li></ul></li><li><a href="#" class="isLabel">flex-admin</a><ul><li><a href="/flex/doc/6-flex-admin/1-Binary.html">Binary</a></li><li><a href="/flex/doc/6-flex-admin/2-Live-Reindex.html">Live Reindex</a></li></ul></li><li><a href="#" class="isLabel">Tutorials</a><ul><li><a href="/flex/doc/7-Tutorials/1-Flex-vs-Tire.html">Why you should use Flex rather than Tire</a></li><li><a href="/flex/doc/7-Tutorials/2-Migrate-from-0.x.html">How to migrate from flex 0.x</a></li><li><a href="/flex/doc/7-Tutorials/3-Index-and-Search-your-Models.html">Index and Search your Models</a></li><li><a href="/flex/doc/7-Tutorials/4-Index-and-Search-External-Data.html">Index and Search External Data</a></li></ul></li></ul>
      <div id="google-search">
        <script type="text/javascript">
          (function() {
            var cx = '001168365143071728136:m_m7r3q0dhs';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
        </script>
        <gcse:search>&nbsp;</gcse:search>
      </div>
    </div>
    <div id="page-toc"></div>
    <div id="content">
      <a id="badge" href="https://badge.fury.io/rb/flex"><img src="https://badge.fury.io/rb/flex.png" /></a>
      <div class="breadcrumb nocontent">
        <span><a href="/flex/doc">FlexDoc</a></span> &gt; <span><a href="/flex/doc/2-flex">flex</a></span> &gt; <span><a href="/flex/doc/2-flex/3-Templating">Templating</a></span> &gt; <span>Template Sources</span>
      </div>
      <h1 id='template_sources'>Template Sources</h1>

<p>Notice: you should know about Templates before reading this section (see <a href='/flex/doc/2-flex/3-Templating/1-Templates.html'>Templates</a>).</p>

<p>Flex Template Sources are just <code>YAML</code> files that can contain multiple template definitions (being the keys the template names). For example:</p>
<div class='highlight'><pre><code class='yaml'><span class='l-Scalar-Plain'>a_named_template</span><span class='p-Indicator'>:</span>
  <span class='l-Scalar-Plain'>query</span><span class='p-Indicator'>:</span>
    <span class='l-Scalar-Plain'>query_string</span><span class='p-Indicator'>:</span>
      <span class='l-Scalar-Plain'>query</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>&lt;&lt;the_string&gt;&gt;</span>
  <span class='l-Scalar-Plain'>...</span>

<span class='l-Scalar-Plain'>another_named_template</span><span class='p-Indicator'>:</span>
  <span class='l-Scalar-Plain'>query</span><span class='p-Indicator'>:</span>
    <span class='l-Scalar-Plain'>term</span><span class='p-Indicator'>:</span>
      <span class='l-Scalar-Plain'>my_attr</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>&lt;&lt;the_term&gt;&gt;</span>
  <span class='l-Scalar-Plain'>...</span>
</code></pre></div>
<p>The magic of loading the source, parsing the templates, instantiating them as objects and make their queries available as methods of your own class is made by adding just a couple of lines to your class:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>MyClass</span>
  <span class='kp'>include</span> <span class='ss'>Flex</span><span class='p'>:</span><span class='ss'>:Templates</span>
  <span class='n'>flex</span><span class='o'>.</span><span class='n'>load_search_source</span> <span class='s1'>&#39;your/template/source.yml&#39;</span>
<span class='k'>end</span>
</code></pre></div>
<p>With that 2 lines you will be able to write for example:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>result1</span> <span class='o'>=</span> <span class='no'>MySearch</span><span class='o'>.</span><span class='n'>a_named_template</span>       <span class='ss'>:the_string</span> <span class='o'>=&gt;</span> <span class='n'>params</span><span class='o'>[</span><span class='ss'>:the_string</span><span class='o'>]</span>
<span class='n'>result2</span> <span class='o'>=</span> <span class='no'>MySearch</span><span class='o'>.</span><span class='n'>another_named_template</span> <span class='ss'>:the_term</span>   <span class='o'>=&gt;</span> <span class='n'>params</span><span class='o'>[</span><span class='ss'>:the_term</span><span class='o'>]</span>

<span class='c1'># or simply</span>
<span class='n'>result1</span> <span class='o'>=</span> <span class='no'>MySearch</span><span class='o'>.</span><span class='n'>a_named_template</span>       <span class='n'>params</span>
<span class='n'>result2</span> <span class='o'>=</span> <span class='no'>MySearch</span><span class='o'>.</span><span class='n'>another_named_template</span> <span class='n'>params</span>
</code></pre></div>
<p>and so retrieving the results from the elasticsearch server by just calling the generated methods.</p>

<h2 id='templates_module'>Templates Module</h2>

<p>Sources are loaded through the <code>Flex::Templates</code> module that you include in your class. You can load one source per class, or more than one source in the same class, even if they are different types of templates. However one source can contain only templates of the same type plus any number of partials templates.</p>

<p>You load different source types with different loading methods (that will use different <code>Flex::Template::*</code> classes):</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>MyClass</span>
  <span class='kp'>include</span> <span class='ss'>Flex</span><span class='p'>:</span><span class='ss'>:Templates</span>
  <span class='n'>flex</span><span class='o'>.</span><span class='n'>load_source</span>             <span class='s1'>&#39;your/template/generic_source.yml&#39;</span>       <span class='c1'># uses Flex::Template</span>
  <span class='n'>flex</span><span class='o'>.</span><span class='n'>load_search_source</span>      <span class='s1'>&#39;your/template/search_source.yml&#39;</span>        <span class='c1'># uses Flex::Template::Search</span>
  <span class='n'>flex</span><span class='o'>.</span><span class='n'>load_slim_search_source</span> <span class='s1'>&#39;your/template/slim_search_source.yml&#39;</span>   <span class='c1'># uses Flex::Template::SlimSearch</span>
<span class='k'>end</span>
</code></pre></div>
<p>If you put the sources into the <code>Configuration.flex_dir</code> path (e.g. <code>/path/to/flex</code>) you can avoid to specify the full path:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>MyClass</span>
  <span class='n'>flex</span><span class='o'>.</span><span class='n'>load_source</span>   <span class='ss'>:generic_source</span>    <span class='c1'># loads &#39;/path/to/flex/generic_source.yml&#39;</span>
  <span class='n'>flex</span><span class='o'>.</span><span class='n'>load_source</span>                      <span class='c1'># loads &#39;/path/to/flex/my_class.yml&#39;</span>
<span class='k'>end</span>
</code></pre></div>
<p>You can also load your custom subclasses with:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>flex</span><span class='o'>.</span><span class='n'>load_source_for</span> <span class='ss'>Your</span><span class='p'>:</span><span class='ss'>:Flex</span><span class='o'>::</span><span class='ss'>Template</span><span class='p'>:</span><span class='ss'>:Subclass</span><span class='p'>,</span> <span class='s1'>&#39;/source/path/as/usual&#39;</span>
</code></pre></div>
<h3 id='inline_source'>Inline Source</h3>

<p>You can also pass the source content string, so defining your templates inline instead in a file:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>flex</span><span class='o'>.</span><span class='n'>load_search_source</span> <span class='o'>&lt;&lt;-</span><span class='no'>yaml</span>
<span class='sh'>  a_named_template:</span>
<span class='sh'>    query:</span>
<span class='sh'>      query_string:</span>
<span class='sh'>        query: &lt;&lt;the_string&gt;&gt;</span>
<span class='sh'>    ...</span>

<span class='sh'>  another_named_template:</span>
<span class='sh'>    query:</span>
<span class='sh'>      term:</span>
<span class='sh'>        my_attr: &lt;&lt;the_term&gt;&gt;</span>
<span class='sh'>    ...</span>
<span class='no'>  yaml</span>
</code></pre></div>
<p>You can define a single Search Template inline, with the <code>define_search</code> method:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>flex</span><span class='o'>.</span><span class='n'>define_search</span> <span class='ss'>:a_named_template</span><span class='p'>,</span> <span class='o'>&lt;&lt;-</span><span class='no'>yaml</span>
<span class='sh'>  query:</span>
<span class='sh'>    query_string:</span>
<span class='sh'>      query: &lt;&lt;the_string&gt;&gt;</span>
<span class='sh'>    ...</span>
<span class='no'>  yaml</span>
</code></pre></div>
<blockquote>
<p><strong>Notice</strong>: since you passed the name of the template as an argument, the <code>YAML</code> string defining the source must not include it.</p>
</blockquote>

<h3 id='template_wrapper'>Template Wrapper</h3>

<p>Sometimes you may need to modify the behaviour of the template methods defined by your sources, for example to pre-process the variables passed to one or more template methods. In that case you can overwrite the original method by using the <code>flex.wrap</code> method. For example:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>MyClass</span>
  <span class='kp'>include</span> <span class='ss'>Flex</span><span class='p'>:</span><span class='ss'>:Templates</span>
  <span class='n'>flex</span><span class='o'>.</span><span class='n'>load_search_source</span>

  <span class='n'>flex</span><span class='o'>.</span><span class='n'>wrap</span> <span class='ss'>:my_template</span><span class='p'>,</span> <span class='ss'>:my_other_template</span> <span class='k'>do</span> <span class='o'>|*</span><span class='n'>vars</span><span class='o'>|</span>
    <span class='k'>super</span> <span class='n'>pre_process</span><span class='p'>(</span><span class='o'>*</span><span class='n'>vars</span><span class='p'>)</span>
  <span class='k'>end</span>

<span class='k'>end</span>
</code></pre></div>
<p>In the example, the <code>load_search_source</code> loads the templates - namely the <code>my_template</code> and the <code>my_other_template</code> - into your <code>MyClass</code>, but you want to preprocess the variables (for example cleaning up the request <code>params</code> that you pass them). The <code>flex.wrap</code> method redefines the orignal methods with its block. Notice that <code>super</code> in the wrapper block context, refers to the original method.</p>

<blockquote>
<p><strong>Notice</strong>: You can omit the template names if you want to wrap all the template methods.</p>
</blockquote>

<h2 id='query_fragment_reuse'>Query Fragment Reuse</h2>

<p>Any Template Source file may contain an optional <code>ANCHORS</code> key, which is simply a literal key that you may use as a sort of storage for fragments of structures. By using the <code>YAML</code> anchor/alias mechanism you can reuse them in more than one templates. The following is a real world example:</p>
<div class='highlight'><pre><code class='yaml'><span class='l-Scalar-Plain'>ANCHORS</span><span class='p-Indicator'>:</span>

  <span class='p-Indicator'>-</span> <span class='nl'>&amp;not_forbidden_areas</span>
      <span class='l-Scalar-Plain'>must_not</span><span class='p-Indicator'>:</span>
      <span class='p-Indicator'>-</span> <span class='l-Scalar-Plain'>terms</span><span class='p-Indicator'>:</span>
          <span class='l-Scalar-Plain'>area_id</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>&lt;&lt; forbidden_areas &gt;&gt;</span>

  <span class='p-Indicator'>-</span> <span class='nl'>&amp;sort_by_recent</span>
    <span class='l-Scalar-Plain'>sort</span><span class='p-Indicator'>:</span>
    <span class='p-Indicator'>-</span> <span class='l-Scalar-Plain'>created</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>desc</span>

  <span class='p-Indicator'>-</span> <span class='nl'>&amp;filter_type</span>
    <span class='l-Scalar-Plain'>filter</span><span class='p-Indicator'>:</span>
      <span class='l-Scalar-Plain'>term</span><span class='p-Indicator'>:</span>
        <span class='l-Scalar-Plain'>_type</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>&lt;&lt;filter_type= ~ &gt;&gt;</span>

 <span class='c1'>### TEMPLATES ###</span>

<span class='l-Scalar-Plain'>last_content</span><span class='p-Indicator'>:</span>
<span class='p-Indicator'>-</span> <span class='l-Scalar-Plain'>query</span><span class='p-Indicator'>:</span>
    <span class='l-Scalar-Plain'>bool</span><span class='p-Indicator'>:</span>
      <span class='l-Scalar-Plain'>&lt;&lt;</span><span class='p-Indicator'>:</span> <span class='nv'>*not_forbidden_areas</span>
  <span class='l-Scalar-Plain'>&lt;&lt;</span><span class='p-Indicator'>:</span> <span class='nv'>*sort_by_recent</span>
  <span class='l-Scalar-Plain'>&lt;&lt;</span><span class='p-Indicator'>:</span> <span class='nv'>*filter_type</span>

<span class='l-Scalar-Plain'>user_activity</span><span class='p-Indicator'>:</span>
<span class='p-Indicator'>-</span> <span class='l-Scalar-Plain'>query</span><span class='p-Indicator'>:</span>
    <span class='l-Scalar-Plain'>bool</span><span class='p-Indicator'>:</span>
      <span class='l-Scalar-Plain'>&lt;&lt;</span><span class='p-Indicator'>:</span> <span class='nv'>*not_forbidden_areas</span>
      <span class='l-Scalar-Plain'>should</span><span class='p-Indicator'>:</span>
      <span class='p-Indicator'>-</span> <span class='l-Scalar-Plain'>term</span><span class='p-Indicator'>:</span>
          <span class='l-Scalar-Plain'>user_id</span><span class='p-Indicator'>:</span> <span class='l-Scalar-Plain'>&lt;&lt;user_id&gt;&gt;</span>
  <span class='l-Scalar-Plain'>&lt;&lt;</span><span class='p-Indicator'>:</span> <span class='nv'>*sort_by_recent</span>
</code></pre></div>
<p>The <code>&#39;ANCHORS&#39;</code> key and its content will not be parsed as a template.</p>

<blockquote>
<p>Notice that since version 1.0 you can use any ALL CAPS key as an anchor, and they will not be parsed as a template.</p>
</blockquote>

<h2 id='erb_in_the_sources'>ERB in the sources</h2>

<p>You can use erb tags in any Flex source. It can be useful to get some variable or creating some static loop, that will avoid you to write multiple times the same structure, like in this source snippet:</p>
<div class='highlight'><pre><code class='erb'><span class='x'>search_facets:</span>
<span class='x'>- query:</span>
<span class='x'>    query_string:</span>
<span class='x'>      query: &lt;&lt;q= &quot;*&quot; &gt;&gt;</span>
<span class='x'>  facets:</span>
<span class='x'>    </span><span class='cp'>&lt;%</span> <span class='no'>APP_SETTINGS</span><span class='o'>[</span><span class='s1'>&#39;facets&#39;</span><span class='o'>].</span><span class='n'>each</span> <span class='k'>do</span> <span class='o'>|</span><span class='nb'>name</span><span class='o'>|</span> <span class='cp'>%&gt;</span><span class='x' />
<span class='x'>    </span><span class='cp'>&lt;%=</span> <span class='nb'>name</span> <span class='cp'>%&gt;</span><span class='x'>:</span>
<span class='x'>      terms:</span>
<span class='x'>        field: </span><span class='cp'>&lt;%=</span> <span class='nb'>name</span> <span class='cp'>%&gt;</span><span class='x' />
<span class='x'>    </span><span class='cp'>&lt;%</span> <span class='k'>end</span> <span class='cp'>%&gt;</span><span class='x' />
</code></pre></div><br />
      <div class="breadcrumb nocontent">
        <span><a href="/flex/doc">FlexDoc</a></span> &gt; <span><a href="/flex/doc/2-flex">flex</a></span> &gt; <span><a href="/flex/doc/2-flex/3-Templating">Templating</a></span> &gt; <span>Template Sources</span>
      </div>
    </div>
    <div id="footer" class="nocontent">
      Copyright &copy; 2012-2013 by <a href="mailto://dd.nexus@gmail.com">Domizio Demichelis</a> &mdash; Sponsored by <a href="http://www.escalatemedia.com">Escalate Media</a> and <a href="http://www.barquin.com">Barquin International</a>
    </div>
  </body>
</html>